CREATE OR REPLACE DATABASE AZUREDATABASE;
USE AZUREDATABASE;

CREATE  TABLE TRANSACTION_RAW 
(household_key	INT,
BASKET_ID	INT,
DAY	INT,
PRODUCT_ID	INT,
QUANTITY	INT,
SALES_VALUE	FLOAT,
STORE_ID	INT,
RETAIL_DISC	FLOAT,
TRANS_TIME	INT,
WEEK_NO	INT,
COUPON_DISC	INT,
COUPON_MATCH_DISC INT
);

create or replace file format RETAIL_TRNXS_CSV
    type = 'csv'
    compression = 'none'
    field_delimiter = ','
    field_optionally_enclosed_by = 'none'
    skip_header = 1;


CREATE OR REPLACE NOTIFICATION INTEGRATION RETAIL_TXNS_INTEGRATION
ENABLED = TRUE
TYPE= QUEUE
NOTIFICATION_PROVIDER= AZURE_STORAGE_QUEUE
AZURE_STORAGE_QUEUE_PRIMARY_URI='https://retailfilestorage.queue.core.windows.net/retail-txn-queue'
AZURE_TENANT_ID='d08908af-ea54-4f51-a05e-cb13e0d75e8d';

SHOW INTEGRATIONS;


desc NOTIFICATION INTEGRATION RETAIL_TXNS_INTEGRATION;



CREATE OR REPLACE STAGE TRANSCATION_STAGE
url = 'azure://retailfilestorage.blob.core.windows.net/retail-txns-container/'
credentials = (azure_sas_token=
'sv=2022-11-02&ss=bfqt&srt=co&sp=rwdlacupiytfx&se=2024-03-05T16:46:50Z&st=2024-03-05T08:46:50Z&spr=https&sig=YRVgigzeQooo9k4wwPGZMTIB6Bkj2qEHK%2BR2A0YzAgs%3D'
);


SHOW STAGES;

LS @TRANSCATION_STAGE;



CREATE OR REPLACE pipe "RETAIL_TRANSCATION_PIPE"
  auto_ingest = true
  integration = 'RETAIL_TXNS_INTEGRATION'
  as
  copy into TRANSACTION_RAW
  from @TRANSCATION_STAGE
  file_format = RETAIL_TRNXS_CSV;

SHOW PIPES;

SELECT COUNT(*) FROM TRANSACTION_RAW;

SELECT * FROM  TRANSACTION_RAW;
  
  
ALTER PIPE RETAIL_TRANSCATION_PIPE REFRESH;

SELECT *
FROM TABLE (INFORMATION_SCHEMA.COPY_HISTORY (TABLE_NAME => 'TRANSACTION_RAW',
START_TIME => DATEADD (HOURS, -1, CURRENT_TIMESTAMP())));
